services:
  mongo:
    image: mongo:7
    restart: always
    volumes:
      - mongo-data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=token-download-manager
    networks:
      - app-network

  redis:
    image: redis:7-alpine
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - app-network

  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    environment:
      - NEXT_PUBLIC_APP_URL=https://faster.p.dishis.tech
      - NEXTAUTH_URL=https://faster.p.dishis.tech
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - MONGODB_URI=mongodb://mongo:27017/token-download-manager
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DOWNLOADS_DIR=/downloads
      - INITIAL_ADMIN_EMAIL=${INITIAL_ADMIN_EMAIL}
      - INITIAL_ADMIN_PASSWORD=${INITIAL_ADMIN_PASSWORD}
    volumes:
      - downloads:/downloads
    depends_on:
      - mongo
      - redis
    networks:
      - app-network

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: always
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Kolkata
      - WEBUI_PORT=8080
    volumes:
      - downloads:/downloads
      - qbittorrent-config:/config
    ports:
      - "8080:8080"         # qbit web ui (optional, for debugging)
      - "51413:51413"       # torrent port TCP
      - "51413:51413/udp"   # torrent port UDP
    networks:
      - app-network

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    restart: always
    environment:
      - NEXT_PUBLIC_APP_URL=https://faster.p.dishis.tech
      - MONGODB_URI=mongodb://mongo:27017/token-download-manager
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DOWNLOADS_DIR=/downloads

      # qbit credentials + host
      - QBIT_HOST=qbittorrent
      - QBIT_PORT=8080
      - QBIT_USERNAME=${INITIAL_ADMIN_EMAIL}
      - QBIT_PASSWORD=${INITIAL_ADMIN_PASSWORD}
    volumes:
      - downloads:/downloads
    depends_on:
      - mongo
      - redis
      - qbittorrent
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - downloads:/downloads:ro
      - certbot-etc:/etc/letsencrypt:ro
      - certbot-var:/var/lib/letsencrypt:ro
    depends_on:
      - app
    networks:
      - app-network

  certbot:
    image: certbot/certbot:latest
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  mongo-data:
  redis-data:
  downloads:
  certbot-etc:
  certbot-var:
  qbittorrent-config:
